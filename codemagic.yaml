workflows:
  ios-release:
    name: iOS Release Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    
    environment:
      # NO configurar ios_signing - el IPA se genera sin firmar
      # Se puede instalar directamente con Sideloadly (firma autom√°tica al instalar)
      # NO requiere certificados configurados en Codemagic
      
      vars:
        XCODE_WORKSPACE: "iosApp/NequixiOS.xcworkspace"
        XCODE_SCHEME: "NequixiOS"
        XCODE_PROJECT: "iosApp/NequixiOS.xcodeproj"
        
      cocoapods: default
      
    scripts:
      - name: Disable Xcode Signing (Build without signing)
        script: |
          # Deshabilitar signing - el IPA se generar√° sin firmar
          # Se puede instalar con Sideloadly que lo firmar√° autom√°ticamente
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$XCODE_PROJECT/project.pbxproj" || \
          sed -i 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$XCODE_PROJECT/project.pbxproj" || true
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' "$XCODE_PROJECT/project.pbxproj" || \
          sed -i 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' "$XCODE_PROJECT/project.pbxproj" || true
          echo "‚úÖ Signing deshabilitado - IPA se generar√° sin firmar (listo para Sideloadly)"
          
      - name: Prepare iOS Build
        script: |
          chmod +x ./gradlew
          chmod +x ./prepare_ios_build.sh || true
          
      - name: Build Shared Framework
        script: |
          echo "üî® Compilando framework compartido para iOS..."
          # Compilar para todas las arquitecturas iOS
          ./gradlew :shared:compileKotlinIosArm64 :shared:compileKotlinIosX64 :shared:compileKotlinIosSimulatorArm64 || echo "Warning: Some iOS targets may not compile"
          
          # Generar el framework para CocoaPods
          ./gradlew :shared:podInstall || {
            echo "Error en podInstall, intentando generar framework manualmente..."
            ./gradlew :shared:linkPodReleaseFrameworkIosArm64 :shared:linkPodReleaseFrameworkIosX64 || true
          }
          
          # Verificar que el framework existe
          if [ -d "shared/build/cocoapods/framework/shared.framework" ]; then
            echo "‚úÖ Framework compartido compilado correctamente"
            FRAMEWORK_SIZE=$(du -sh shared/build/cocoapods/framework/shared.framework | cut -f1)
            echo "üìä Tama√±o del framework: $FRAMEWORK_SIZE"
            ls -lh shared/build/cocoapods/framework/shared.framework/
            
            # Verificar que el framework tenga el binario
            if [ -f "shared/build/cocoapods/framework/shared.framework/shared" ]; then
              BINARY_SIZE=$(du -h shared/build/cocoapods/framework/shared.framework/shared | cut -f1)
              echo "‚úÖ Binario del framework encontrado - Tama√±o: $BINARY_SIZE"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: No se encontr√≥ el binario del framework"
            fi
          else
            echo "‚ö†Ô∏è Framework no encontrado en ubicaci√≥n esperada"
            find shared/build -name "shared.framework" -type d || echo "No se encontr√≥ framework"
          fi
          
      - name: Install CocoaPods Dependencies
        script: |
          cd iosApp
          echo "üì¶ Instalando dependencias de CocoaPods..."
          pod install --repo-update
          echo "‚úÖ CocoaPods instalado"
          
          # Dar permisos de ejecuci√≥n a todos los scripts de CocoaPods
          echo "üîß Dando permisos de ejecuci√≥n a scripts de CocoaPods..."
          find "Pods/Target Support Files" -name "*.sh" -type f -exec chmod +x {} \; || true
          
          # Corregir el script de CocoaPods para evitar error de variable no definida
          FRAMEWORKS_SCRIPT="Pods/Target Support Files/Pods-NequixiOS/Pods-NequixiOS-frameworks.sh"
          if [ -f "$FRAMEWORKS_SCRIPT" ]; then
            echo "üîß Corrigiendo script de CocoaPods..."
            chmod +x "$FRAMEWORKS_SCRIPT"
            # Agregar verificaci√≥n de variables antes de usar source
            sed -i '' 's/source "$SCRIPT_INPUT_FILE_0"/[ -f "$SCRIPT_INPUT_FILE_0" ] \&\& source "$SCRIPT_INPUT_FILE_0"/g' "$FRAMEWORKS_SCRIPT" || \
            sed -i 's/source "$SCRIPT_INPUT_FILE_0"/[ -f "$SCRIPT_INPUT_FILE_0" ] \&\& source "$SCRIPT_INPUT_FILE_0"/g' "$FRAMEWORKS_SCRIPT" || true
            # Deshabilitar modo estricto en el script - usar echo en lugar de sed con newline
            echo -e "set +u\n$(cat $FRAMEWORKS_SCRIPT)" > "$FRAMEWORKS_SCRIPT.tmp" && mv "$FRAMEWORKS_SCRIPT.tmp" "$FRAMEWORKS_SCRIPT" || true
            chmod +x "$FRAMEWORKS_SCRIPT"
            echo "‚úÖ Script corregido y con permisos"
            
            # Verificar que el script de embed frameworks existe
            EMBED_SCRIPT="Pods/Target Support Files/Pods-NequixiOS/Pods-NequixiOS-frameworks.sh"
            if [ -f "$EMBED_SCRIPT" ]; then
              echo "‚úÖ Script de embed frameworks encontrado"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: Script de embed frameworks no encontrado"
            fi
          fi
          
          # Verificar que los frameworks de CocoaPods se generaron
          echo "üîç Verificando frameworks de CocoaPods generados..."
          if [ -d "Pods" ]; then
            POD_FRAMEWORKS=$(find Pods -name "*.framework" -type d | wc -l | tr -d ' ')
            echo "üì¶ Frameworks encontrados en Pods: $POD_FRAMEWORKS"
            if [ "$POD_FRAMEWORKS" -lt 5 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: Pocos frameworks encontrados en Pods"
            fi
          fi
          
          # Fix directo: eliminar CopySwiftLibs de targets _Privacy modificando project.pbxproj
          echo "üîß Aplicando fix directo para CopySwiftLibs en targets _Privacy..."
          if [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            # Crear backup
            cp Pods/Pods.xcodeproj/project.pbxproj Pods/Pods.xcodeproj/project.pbxproj.backup
            
            # Ejecutar script Python para modificar el archivo
            if [ -f "../fix_copyswiftlibs.py" ]; then
              python3 ../fix_copyswiftlibs.py || echo "‚ö†Ô∏è Error ejecutando fix script, continuando..."
            else
              echo "‚ö†Ô∏è Script fix_copyswiftlibs.py no encontrado"
            fi
          fi
          cd ..
          
      - name: Pre-build shared framework for CocoaPods
        script: |
          echo "üî® Pre-compilando framework para evitar error en script phase..."
          # Pre-compilar el framework para que CocoaPods no intente compilarlo durante el build
          export OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES
          ./gradlew :shared:syncFramework \
            -Pkotlin.native.cocoapods.platform=iphoneos \
            -Pkotlin.native.cocoapods.archs="arm64" \
            -Pkotlin.native.cocoapods.configuration=Release || echo "Warning: syncFramework puede fallar, continuando..."
          
      - name: Build IPA (ready for Sideloadly installation)
        script: |
          set +e  # No salir inmediatamente en errores
          set +u  # No tratar variables no definidas como error
          mkdir -p build/ios/ipa
          
          # Deshabilitar el script phase de CocoaPods que est√° fallando
          export OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES
          
          # Configurar variables para el script de CocoaPods
          export STRIP_INSTALLED_PRODUCT=YES
          export EMBEDDED_CONTENT_CONTAINS_SWIFT=YES
          export ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES
          
          echo "üîç Verificando workspace y scheme..."
          ls -la "$XCODE_WORKSPACE" || echo "Workspace no encontrado"
          xcodebuild -list -workspace "$XCODE_WORKSPACE" || echo "Error listando workspace"
          
          echo "üì¶ Compilando archive con frameworks embebidos..."
          # Asegurar que los frameworks se embeban correctamente
          export EMBEDDED_CONTENT_CONTAINS_SWIFT=YES
          export ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES
          export STRIP_INSTALLED_PRODUCT=NO  # NO stripear para incluir todo
          
          # Intentar build con diferentes opciones
          xcodebuild -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath build/archive.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM="" \
            OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES \
            EMBEDDED_CONTENT_CONTAINS_SWIFT=YES \
            ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES \
            archive 2>&1 | tee build.log || {
            echo "‚ùå Error en archive, intentando build directo..."
            # Intentar build sin archive (sin firma)
            xcodebuild -workspace "$XCODE_WORKSPACE" \
              -scheme "$XCODE_SCHEME" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES \
              build
            # Buscar el .app compilado
            APP_PATH=$(find build -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "‚úÖ App encontrada en: $APP_PATH"
              mkdir -p build/ios/ipa/Payload
              cp -R "$APP_PATH" build/ios/ipa/Payload/
              cd build/ios/ipa
              zip -r ../NequixiOS.ipa Payload
              cd ../../..
              echo "‚úÖ IPA creado desde build directo"
              exit 0
            fi
            echo "‚ùå Error completo del build"
            cat build.log || true
            exit 1
          }
          
          echo "üì¶ Verificando archive creado..."
          if [ -d "build/archive.xcarchive/Products/Applications" ]; then
            APP_NAME=$(ls build/archive.xcarchive/Products/Applications/ | head -1)
            APP_PATH="build/archive.xcarchive/Products/Applications/$APP_NAME"
            echo "‚úÖ App encontrada: $APP_NAME"
            
            # Verificar tama√±o del .app (debe ser al menos varios MB)
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "üìä Tama√±o del .app: ${APP_SIZE}MB"
            
            if [ "$APP_SIZE" -lt 1 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: El .app es muy peque√±o (${APP_SIZE}MB). Verificando contenido..."
              echo "Contenido del .app:"
              ls -lh "$APP_PATH" || true
              echo "Frameworks:"
              ls -lh "$APP_PATH/Frameworks" 2>/dev/null || echo "‚ö†Ô∏è No se encontr√≥ carpeta Frameworks"
              echo "Recursos:"
              ls -lh "$APP_PATH"/*.plist 2>/dev/null || echo "‚ö†Ô∏è No se encontraron plists"
            fi
            
            # Verificar frameworks incluidos
            echo "üîç Verificando frameworks incluidos en el .app..."
            if [ -d "$APP_PATH/Frameworks" ]; then
              FRAMEWORK_COUNT=$(find "$APP_PATH/Frameworks" -name "*.framework" -type d | wc -l | tr -d ' ')
              echo "‚úÖ Carpeta Frameworks encontrada con $FRAMEWORK_COUNT frameworks"
              echo "üì¶ Frameworks encontrados:"
              find "$APP_PATH/Frameworks" -name "*.framework" -type d -exec basename {} \; | sort
              
              # Verificar shared framework
              if [ -d "$APP_PATH/Frameworks/shared.framework" ]; then
                SHARED_SIZE=$(du -sh "$APP_PATH/Frameworks/shared.framework" | cut -f1)
                echo "‚úÖ Framework compartido encontrado - Tama√±o: $SHARED_SIZE"
                ls -lh "$APP_PATH/Frameworks/shared.framework/shared" 2>/dev/null || echo "‚ö†Ô∏è Binario del framework no encontrado"
              else
                echo "‚ùå ERROR CR√çTICO: Framework compartido NO encontrado"
                find "$APP_PATH" -name "shared.framework" -type d || echo "No se encontr√≥ shared.framework"
              fi
              
              # Verificar Firebase frameworks
              FIREBASE_FRAMEWORKS=$(find "$APP_PATH/Frameworks" -name "*Firebase*.framework" -type d | wc -l | tr -d ' ')
              echo "üì¶ Frameworks de Firebase encontrados: $FIREBASE_FRAMEWORKS"
              if [ "$FIREBASE_FRAMEWORKS" -lt 4 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: Deber√≠an haber al menos 4 frameworks de Firebase"
              fi
            else
              echo "‚ùå ERROR CR√çTICO: Carpeta Frameworks NO existe en el .app"
              echo "üîß Intentando copiar frameworks manualmente..."
              
              # Crear carpeta Frameworks
              mkdir -p "$APP_PATH/Frameworks"
              
              # Copiar frameworks de CocoaPods (buscar en varias ubicaciones)
              echo "üì¶ Buscando frameworks de CocoaPods..."
              
              # Ubicaci√≥n 1: Pods directo
              if [ -d "iosApp/Pods" ]; then
                echo "  Buscando en iosApp/Pods..."
                find iosApp/Pods -name "*.framework" -type d | while read framework; do
                  framework_name=$(basename "$framework")
                  if [ ! -d "$APP_PATH/Frameworks/$framework_name" ]; then
                    echo "    Copiando $framework_name..."
                    cp -R "$framework" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 2: Build products de CocoaPods
              if [ -d "iosApp/build" ]; then
                echo "  Buscando en iosApp/build..."
                find iosApp/build -name "*.framework" -type d | while read framework; do
                  framework_name=$(basename "$framework")
                  if [ ! -d "$APP_PATH/Frameworks/$framework_name" ]; then
                    echo "    Copiando $framework_name..."
                    cp -R "$framework" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 3: DerivedData (si existe)
              if [ -d "$HOME/Library/Developer/Xcode/DerivedData" ]; then
                echo "  Buscando en DerivedData..."
                find "$HOME/Library/Developer/Xcode/DerivedData" -name "*.framework" -type d 2>/dev/null | while read framework; do
                  framework_name=$(basename "$framework")
                  if [ ! -d "$APP_PATH/Frameworks/$framework_name" ]; then
                    echo "    Copiando $framework_name..."
                    cp -R "$framework" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Copiar shared framework (buscar en varias ubicaciones)
              echo "üì¶ Buscando shared framework..."
              
              # Ubicaci√≥n 1: build/xcode-frameworks
              if [ -d "shared/build/xcode-frameworks" ]; then
                find shared/build/xcode-frameworks -name "shared.framework" -type d | while read shared_fw; do
                  if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
                    echo "  Copiando shared.framework desde xcode-frameworks..."
                    cp -R "$shared_fw" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 2: build/ios (Kotlin Native)
              if [ -d "shared/build/ios" ]; then
                find shared/build/ios -name "shared.framework" -type d | while read shared_fw; do
                  if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
                    echo "  Copiando shared.framework desde build/ios..."
                    cp -R "$shared_fw" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 3: Pods (si CocoaPods lo copi√≥)
              if [ -d "iosApp/Pods/shared" ]; then
                find iosApp/Pods/shared -name "shared.framework" -type d | while read shared_fw; do
                  if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
                    echo "  Copiando shared.framework desde Pods..."
                    cp -R "$shared_fw" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Verificar nuevamente
              if [ -d "$APP_PATH/Frameworks" ]; then
                FRAMEWORK_COUNT=$(find "$APP_PATH/Frameworks" -name "*.framework" -type d | wc -l | tr -d ' ')
                echo "‚úÖ Frameworks copiados manualmente: $FRAMEWORK_COUNT frameworks"
                if [ "$FRAMEWORK_COUNT" -gt 0 ]; then
                  echo "üì¶ Frameworks encontrados:"
                  find "$APP_PATH/Frameworks" -name "*.framework" -type d -exec basename {} \; | sort
                  
                  # Verificar tama√±os
                  echo "üìä Tama√±os de frameworks:"
                  du -sh "$APP_PATH/Frameworks"/*.framework 2>/dev/null | sort -h
                else
                  echo "‚ö†Ô∏è ADVERTENCIA: No se encontraron frameworks para copiar"
                  echo "Buscando frameworks en el sistema..."
                  find . -name "*.framework" -type d 2>/dev/null | head -10
                fi
              else
                echo "‚ùå ERROR: No se pudo crear la carpeta Frameworks"
                echo "Contenido del .app:"
                ls -la "$APP_PATH" | head -20
              fi
            fi
            
            # Asegurar que los frameworks est√©n incluidos ANTES de crear el IPA
            echo "üîç Verificaci√≥n final antes de crear IPA..."
            if [ ! -d "$APP_PATH/Frameworks" ] || [ -z "$(ls -A "$APP_PATH/Frameworks" 2>/dev/null)" ]; then
              echo "‚ùå ERROR: No hay frameworks en el .app. El IPA NO funcionar√°."
              echo "Intentando copiar frameworks una vez m√°s..."
              mkdir -p "$APP_PATH/Frameworks"
              
              # Buscar y copiar todos los frameworks disponibles
              find . -name "*.framework" -type d 2>/dev/null | grep -E "(Firebase|shared|Pods)" | while read fw; do
                fw_name=$(basename "$fw")
                if [ ! -d "$APP_PATH/Frameworks/$fw_name" ]; then
                  echo "  Copiando $fw_name desde $(dirname $fw)..."
                  cp -R "$fw" "$APP_PATH/Frameworks/" 2>/dev/null || true
                fi
              done
              
              FRAMEWORK_COUNT=$(find "$APP_PATH/Frameworks" -name "*.framework" -type d 2>/dev/null | wc -l | tr -d ' ')
              if [ "$FRAMEWORK_COUNT" -lt 5 ]; then
                echo "‚ùå ERROR CR√çTICO: Solo se encontraron $FRAMEWORK_COUNT frameworks. Se necesitan al menos 5."
                echo "El IPA NO funcionar√° correctamente."
                exit 1
              fi
            fi
            
            # Verificar tama√±o final del .app
            FINAL_APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "üìä Tama√±o final del .app: ${FINAL_APP_SIZE}MB"
            if [ "$FINAL_APP_SIZE" -lt 5 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: El .app es muy peque√±o (${FINAL_APP_SIZE}MB). Puede faltar contenido."
            fi
            
            # Crear IPA manualmente (sin firma - Sideloadly lo firmar√° al instalar)
            echo "üì¶ Creando IPA desde archive (listo para instalar con Sideloadly)..."
            mkdir -p build/ios/ipa/Payload
            cp -R "$APP_PATH" build/ios/ipa/Payload/
            cd build/ios/ipa
            zip -r ../NequixiOS.ipa Payload
            cd ../../..
            echo "‚úÖ IPA creado sin firma - Se puede instalar directamente con Sideloadly"
            
            # Buscar el IPA generado
            IPA_PATH=$(find build/ios/ipa -name "*.ipa" -type f | head -1)
            if [ -z "$IPA_PATH" ]; then
              IPA_PATH="build/ios/ipa/NequixiOS.ipa"
            fi
            echo "‚úÖ IPA creado: $IPA_PATH"
            # Verificar que el IPA existe
            if [ -f "$IPA_PATH" ]; then
              IPA_SIZE=$(du -h "$IPA_PATH" | cut -f1)
              IPA_SIZE_MB=$(du -sm "$IPA_PATH" | cut -f1)
              ls -lh "$IPA_PATH"
              echo "‚úÖ IPA verificado correctamente - Tama√±o: ${IPA_SIZE} (${IPA_SIZE_MB}MB)"
              
              if [ "$IPA_SIZE_MB" -lt 5 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: El IPA es muy peque√±o (${IPA_SIZE_MB}MB). Puede faltar contenido."
                echo "Verificando contenido del IPA..."
                unzip -l "$IPA_PATH" | head -30
              elif [ "$IPA_SIZE_MB" -lt 20 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: El IPA es peque√±o (${IPA_SIZE_MB}MB). Deber√≠a ser ~30-50MB con todos los frameworks."
                echo "Verificando frameworks incluidos..."
                unzip -l "$IPA_PATH" | grep -E "(Frameworks|\.framework)" | head -20
              else
                echo "‚úÖ Tama√±o del IPA parece correcto (${IPA_SIZE_MB}MB)"
              fi
            else
              echo "‚ö†Ô∏è IPA no encontrado en $IPA_PATH, buscando..."
              FOUND_IPA=$(find build -name "*.ipa" -type f | head -1)
              if [ -n "$FOUND_IPA" ]; then
                echo "‚úÖ IPA encontrado en: $FOUND_IPA"
                ls -lh "$FOUND_IPA"
                # Copiar al lugar esperado
                mkdir -p build/ios/ipa
                cp "$FOUND_IPA" "$IPA_PATH"
                echo "‚úÖ IPA copiado a ubicaci√≥n esperada"
              else
                echo "‚ùå No se encontr√≥ ning√∫n IPA"
                exit 1
              fi
            fi
          else
            echo "‚ùå No se encontr√≥ la aplicaci√≥n en el archive"
            echo "Contenido de archive:"
            ls -la build/archive.xcarchive/ || true
            ls -la build/archive.xcarchive/Products/ || true
            exit 1
          fi
            
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/ipa/NequixiOS.ipa
      
    publishing:
      email:
        recipients:
          - tu-email@gmail.com
        notify:
          success: true
          failure: true

