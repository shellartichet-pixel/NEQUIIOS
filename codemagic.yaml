workflows:
  ios-release:
    name: iOS Release Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    
    environment:
      # NO configurar ios_signing - El IPA se generar√° sin firmar
      # AppTzio firmar√° autom√°ticamente el IPA al instalarlo
      # Esto evita errores de perfiles de aprovisionamiento faltantes
      
      vars:
        XCODE_WORKSPACE: "iosApp/NequixiOS.xcworkspace"
        XCODE_SCHEME: "NequixiOS"
        XCODE_PROJECT: "iosApp/NequixiOS.xcodeproj"
        
      cocoapods: default
      xcode: latest
      
    scripts:
      - name: Disable Code Signing (IPA sin firmar para AppTzio)
        script: |
          echo "üîê Deshabilitando firma - El IPA se generar√° sin firmar"
          echo "‚úÖ AppTzio firmar√° autom√°ticamente el IPA al instalarlo"
          # Deshabilitar signing en el proyecto Xcode
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$XCODE_PROJECT/project.pbxproj" || \
          sed -i 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$XCODE_PROJECT/project.pbxproj" || true
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' "$XCODE_PROJECT/project.pbxproj" || \
          sed -i 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' "$XCODE_PROJECT/project.pbxproj" || true
          echo "‚úÖ Signing deshabilitado - IPA listo para AppTzio"
          
      - name: Prepare iOS Build
        script: |
          chmod +x ./gradlew
          chmod +x ./prepare_ios_build.sh || true
          
      - name: Build Shared Framework (Kotlin Multiplatform)
        script: |
          echo "üî® Compilando framework compartido Kotlin Multiplatform para iOS..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Paso 1: Compilar para todas las arquitecturas iOS necesarias
          echo "üì± Compilando para arquitecturas iOS..."
          ./gradlew :shared:compileKotlinIosArm64 :shared:compileKotlinIosX64 || {
            echo "‚ùå Error compilando Kotlin para iOS"
            exit 1
          }
          
          # Paso 2: Generar el framework para CocoaPods (esto es cr√≠tico)
          echo "üì¶ Generando framework para CocoaPods..."
          ./gradlew :shared:podInstall || {
            echo "‚ùå Error en podInstall - intentando m√©todo alternativo..."
            # M√©todo alternativo: generar frameworks directamente
            ./gradlew :shared:linkPodReleaseFrameworkIosArm64 :shared:linkPodReleaseFrameworkIosX64 || {
              echo "‚ùå Error cr√≠tico: No se pudo generar el framework de Kotlin"
              exit 1
            }
          }
          
          # Paso 3: Verificaci√≥n exhaustiva del framework
          echo "üîç Verificando framework generado..."
          FRAMEWORK_PATHS=(
            "shared/build/cocoapods/framework/shared.framework"
            "shared/build/xcode-frameworks/shared.framework"
            "shared/build/ios/arm64/shared.framework"
          )
          
          FRAMEWORK_FOUND=false
          for FRAMEWORK_PATH in "${FRAMEWORK_PATHS[@]}"; do
            if [ -d "$FRAMEWORK_PATH" ]; then
              echo "‚úÖ Framework encontrado en: $FRAMEWORK_PATH"
              FRAMEWORK_FOUND=true
              
              # Verificar tama√±o
              FRAMEWORK_SIZE=$(du -sh "$FRAMEWORK_PATH" | cut -f1)
            echo "üìä Tama√±o del framework: $FRAMEWORK_SIZE"
              
              # Verificar binario
              if [ -f "$FRAMEWORK_PATH/shared" ]; then
                BINARY_SIZE=$(du -h "$FRAMEWORK_PATH/shared" | cut -f1)
                echo "‚úÖ Binario encontrado - Tama√±o: $BINARY_SIZE"
                
                # Verificar que el binario no est√© vac√≠o
                if [ ! -s "$FRAMEWORK_PATH/shared" ]; then
                  echo "‚ùå ERROR: El binario del framework est√° vac√≠o"
                  exit 1
                fi
                
                # Verificar arquitecturas incluidas
                echo "üîç Verificando arquitecturas en el binario..."
                file "$FRAMEWORK_PATH/shared" || true
                lipo -info "$FRAMEWORK_PATH/shared" 2>/dev/null || echo "‚ö†Ô∏è lipo no disponible, continuando..."
            else
                echo "‚ùå ERROR: No se encontr√≥ el binario del framework"
                exit 1
            fi
              
              # Listar contenido del framework
              echo "üì¶ Contenido del framework:"
              ls -lh "$FRAMEWORK_PATH/" | head -10
              break
            fi
          done
          
          if [ "$FRAMEWORK_FOUND" = false ]; then
            echo "‚ùå ERROR CR√çTICO: Framework de Kotlin NO encontrado en ninguna ubicaci√≥n"
            echo "Buscando en todo el directorio shared/build..."
            find shared/build -name "shared.framework" -type d || echo "No se encontr√≥ framework"
            exit 1
          fi
          
          echo "‚úÖ Framework Kotlin Multiplatform compilado y verificado correctamente"
          
      - name: Install CocoaPods Dependencies
        script: |
          cd iosApp
          echo "üì¶ Instalando dependencias de CocoaPods..."
          pod install --repo-update
          echo "‚úÖ CocoaPods instalado"
          
          # Dar permisos de ejecuci√≥n a todos los scripts de CocoaPods
          echo "üîß Dando permisos de ejecuci√≥n a scripts de CocoaPods..."
          find "Pods/Target Support Files" -name "*.sh" -type f -exec chmod +x {} \; || true
          
          # Corregir el script de CocoaPods para evitar error de variable no definida
          FRAMEWORKS_SCRIPT="Pods/Target Support Files/Pods-NequixiOS/Pods-NequixiOS-frameworks.sh"
          if [ -f "$FRAMEWORKS_SCRIPT" ]; then
            echo "üîß Corrigiendo script de CocoaPods..."
            chmod +x "$FRAMEWORKS_SCRIPT"
            # Agregar verificaci√≥n de variables antes de usar source
            sed -i '' 's/source "$SCRIPT_INPUT_FILE_0"/[ -f "$SCRIPT_INPUT_FILE_0" ] \&\& source "$SCRIPT_INPUT_FILE_0"/g' "$FRAMEWORKS_SCRIPT" || \
            sed -i 's/source "$SCRIPT_INPUT_FILE_0"/[ -f "$SCRIPT_INPUT_FILE_0" ] \&\& source "$SCRIPT_INPUT_FILE_0"/g' "$FRAMEWORKS_SCRIPT" || true
            # Deshabilitar modo estricto en el script - usar echo en lugar de sed con newline
            echo -e "set +u\n$(cat $FRAMEWORKS_SCRIPT)" > "$FRAMEWORKS_SCRIPT.tmp" && mv "$FRAMEWORKS_SCRIPT.tmp" "$FRAMEWORKS_SCRIPT" || true
            chmod +x "$FRAMEWORKS_SCRIPT"
            echo "‚úÖ Script corregido y con permisos"
            
            # Verificar que el script de embed frameworks existe
            EMBED_SCRIPT="Pods/Target Support Files/Pods-NequixiOS/Pods-NequixiOS-frameworks.sh"
            if [ -f "$EMBED_SCRIPT" ]; then
              echo "‚úÖ Script de embed frameworks encontrado"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: Script de embed frameworks no encontrado"
            fi
          fi
          
          # Verificar que los frameworks de CocoaPods se generaron
          echo "üîç Verificando frameworks de CocoaPods generados..."
          if [ -d "Pods" ]; then
            POD_FRAMEWORKS=$(find Pods -name "*.framework" -type d | wc -l | tr -d ' ')
            echo "üì¶ Frameworks encontrados en Pods: $POD_FRAMEWORKS"
            if [ "$POD_FRAMEWORKS" -lt 5 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: Pocos frameworks encontrados en Pods"
            fi
          fi
          
          # Fix CR√çTICO: Eliminar CopySwiftLibs de targets _Privacy usando script Python
          echo "üîß Aplicando fix CR√çTICO para CopySwiftLibs en targets _Privacy..."
          if [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            # Usar script Python para eliminar CopySwiftLibs
            if [ -f "fix_copyswiftlibs.py" ]; then
              echo "  Ejecutando fix_copyswiftlibs.py..."
              python3 fix_copyswiftlibs.py || echo "‚ö†Ô∏è Error ejecutando fix script"
            elif [ -f "../fix_copyswiftlibs.py" ]; then
              echo "  Ejecutando fix_copyswiftlibs.py desde directorio padre..."
              python3 ../fix_copyswiftlibs.py || echo "‚ö†Ô∏è Error ejecutando fix script"
            else
              echo "  ‚ö†Ô∏è Script fix_copyswiftlibs.py no encontrado, usando sed como respaldo..."
            fi
            echo "‚úÖ Fix aplicado a project.pbxproj"
          else
            echo "‚ö†Ô∏è Pods/Pods.xcodeproj/project.pbxproj no encontrado"
          fi
          cd ..
          
      - name: Fix CopySwiftLibs ANTES del build (CR√çTICO - M√âTODO AGRESIVO)
        script: |
          echo "üîß Aplicando fix AGRESIVO para CopySwiftLibs antes del build..."
          cd iosApp
          
          if [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            echo "  Eliminando TODAS las referencias a CopySwiftLibs para _Privacy..."
            
            # M√©todo 1: Script Python si existe
            if [ -f "fix_copyswiftlibs.py" ]; then
              python3 fix_copyswiftlibs.py || echo "‚ö†Ô∏è Error en fix script"
            elif [ -f "../fix_copyswiftlibs.py" ]; then
              python3 ../fix_copyswiftlibs.py || echo "‚ö†Ô∏è Error en fix script"
            fi
            
            # M√©todo 2: Eliminar l√≠neas completas que contengan CopySwiftLibs y _Privacy
            echo "  Eliminando l√≠neas con sed (m√©todo agresivo)..."
            sed -i '' '/nanopb_Privacy.*CopySwiftLibs/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i '/nanopb_Privacy.*CopySwiftLibs/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || true
            
            sed -i '' '/nanopb_Privacy.*swiftStdLibTool/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i '/nanopb_Privacy.*swiftStdLibTool/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || true
            
            sed -i '' '/leveldb_Privacy.*CopySwiftLibs/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i '/leveldb_Privacy.*CopySwiftLibs/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || true
            
            # M√©todo 3: Eliminar build phases completos usando awk (m√°s robusto)
            echo "  Eliminando build phases completos con awk..."
            awk '
            /nanopb_Privacy|leveldb_Privacy/ {
                in_privacy = 1
            }
            in_privacy && /CopySwiftLibs|swiftStdLibTool/ {
                skip_until_close = 1
                brace_count = 0
                next
            }
            skip_until_close {
                brace_count += gsub(/\{/, "") - gsub(/\}/, "")
                if (brace_count <= 0 && /[;}]/) {
                    skip_until_close = 0
                }
                next
            }
            { print }
            ' Pods/Pods.xcodeproj/project.pbxproj > Pods/Pods.xcodeproj/project.pbxproj.tmp && \
            mv Pods/Pods.xcodeproj/project.pbxproj.tmp Pods/Pods.xcodeproj/project.pbxproj || echo "‚ö†Ô∏è Error en awk, continuando..."
            
            # M√©todo 4: Deshabilitar CopySwiftLibs en build settings directamente
            echo "  Deshabilitando CopySwiftLibs en build settings..."
            sed -i '' 's/ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES = YES/ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES = NO/g' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i 's/ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES = YES/ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES = NO/g' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || true
            
            # Verificar que se elimin√≥
            if grep -q "nanopb_Privacy.*CopySwiftLibs" Pods/Pods.xcodeproj/project.pbxproj; then
              echo "‚ö†Ô∏è ADVERTENCIA: A√∫n hay referencias a CopySwiftLibs"
            else
              echo "‚úÖ Verificado: CopySwiftLibs eliminado de nanopb_Privacy"
            fi
            
            echo "‚úÖ Fix agresivo aplicado antes del build"
          else
            echo "‚ö†Ô∏è Pods/Pods.xcodeproj/project.pbxproj no encontrado"
          fi
          cd ..
          
      - name: Pre-build shared framework for CocoaPods
        script: |
          echo "üî® Pre-compilando framework para evitar error en script phase..."
          # Pre-compilar el framework para que CocoaPods no intente compilarlo durante el build
          export OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES
          ./gradlew :shared:syncFramework \
            -Pkotlin.native.cocoapods.platform=iphoneos \
            -Pkotlin.native.cocoapods.archs="arm64" \
            -Pkotlin.native.cocoapods.configuration=Release || echo "Warning: syncFramework puede fallar, continuando..."
          
      - name: Build IPA (ready for Sideloadly installation)
        script: |
          set +e  # No salir inmediatamente en errores
          set +u  # No tratar variables no definidas como error
          mkdir -p build/ios/ipa
          
          # Deshabilitar el script phase de CocoaPods que est√° fallando
          export OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES
          
          # Configurar variables para el script de CocoaPods
          export STRIP_INSTALLED_PRODUCT=YES
          export EMBEDDED_CONTENT_CONTAINS_SWIFT=YES
          export ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES
          
          echo "üîç Verificando workspace y scheme..."
          ls -la "$XCODE_WORKSPACE" || echo "Workspace no encontrado"
          xcodebuild -list -workspace "$XCODE_WORKSPACE" || echo "Error listando workspace"
          
          echo "üì¶ Compilando archive con frameworks embebidos..."
          # Asegurar que los frameworks se embeban correctamente
          export EMBEDDED_CONTENT_CONTAINS_SWIFT=YES
          export ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES
          export STRIP_INSTALLED_PRODUCT=NO  # NO stripear para incluir todo
          
          # Fix FINAL: Eliminar CopySwiftLibs justo antes del build
          echo "üîß Aplicando fix FINAL justo antes del build de Xcode..."
          cd iosApp
          if [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            # Eliminar build phases de CopySwiftLibs usando Python
            python3 fix_copyswiftlibs.py 2>/dev/null || python3 ../fix_copyswiftlibs.py 2>/dev/null || true
            
            # Eliminar usando sed como respaldo
            sed -i '' '/nanopb_Privacy.*CopySwiftLibs/d; /nanopb_Privacy.*swiftStdLibTool/d; /leveldb_Privacy.*CopySwiftLibs/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i '/nanopb_Privacy.*CopySwiftLibs/d; /nanopb_Privacy.*swiftStdLibTool/d; /leveldb_Privacy.*CopySwiftLibs/d' Pods/Pods.xcodeproj/project.pbxproj 2>/dev/null || true
          fi
          cd ..
          
          # Build archive SIN firma (AppTzio firmar√° autom√°ticamente al instalar)
          # Ignorar errores de CopySwiftLibs en _Privacy bundles (no cr√≠ticos)
          xcodebuild -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath build/archive.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM="" \
            OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES \
            EMBEDDED_CONTENT_CONTAINS_SWIFT=YES \
            ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=NO \
            STRIP_INSTALLED_PRODUCT=NO \
            archive 2>&1 | tee build.log | grep -v "nanopb_Privacy.*CopySwiftLibs" | grep -v "leveldb_Privacy.*CopySwiftLibs" || {
            
            # Si falla, verificar si es solo por CopySwiftLibs en _Privacy (no cr√≠tico)
            if grep -q "nanopb_Privacy.*CopySwiftLibs\|leveldb_Privacy.*CopySwiftLibs" build.log; then
              echo "‚ö†Ô∏è Error de CopySwiftLibs en _Privacy (no cr√≠tico), intentando continuar..."
              # Verificar si el archive se cre√≥ a pesar del error
              if [ -d "build/archive.xcarchive/Products/Applications" ]; then
                echo "‚úÖ Archive creado a pesar del error de CopySwiftLibs"
                # Continuar con el proceso
              else
                echo "‚ùå Archive no se cre√≥, el error es cr√≠tico"
                cat build.log | tail -50
                exit 1
              fi
            else
              echo "‚ùå Error diferente, mostrando logs..."
              cat build.log | tail -50
              exit 1
            fi
          }
            echo "‚ùå Error en archive, intentando build directo..."
            # Intentar build sin archive (fallback)
            xcodebuild -workspace "$XCODE_WORKSPACE" \
              -scheme "$XCODE_SCHEME" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              OVERRIDE_KOTLIN_BUILD_IDE_SUPPORTED=YES \
              build
            # Buscar el .app compilado
            APP_PATH=$(find build -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "‚úÖ App encontrada en: $APP_PATH"
              mkdir -p build/ios/ipa/Payload
              cp -R "$APP_PATH" build/ios/ipa/Payload/
              cd build/ios/ipa
              zip -r ../NequixiOS.ipa Payload
              cd ../../..
              echo "‚úÖ IPA creado desde build directo"
              exit 0
            fi
            echo "‚ùå Error completo del build"
            cat build.log || true
            exit 1
          }
          
          echo "üì¶ Verificando archive creado..."
          if [ -d "build/archive.xcarchive/Products/Applications" ]; then
            APP_NAME=$(ls build/archive.xcarchive/Products/Applications/ | head -1)
            APP_PATH="build/archive.xcarchive/Products/Applications/$APP_NAME"
            echo "‚úÖ App encontrada: $APP_NAME"
            
            # Verificar tama√±o del .app (debe ser al menos varios MB)
            APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "üìä Tama√±o del .app: ${APP_SIZE}MB"
            
            if [ "$APP_SIZE" -lt 1 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: El .app es muy peque√±o (${APP_SIZE}MB). Verificando contenido..."
              echo "Contenido del .app:"
              ls -lh "$APP_PATH" || true
              echo "Frameworks:"
              ls -lh "$APP_PATH/Frameworks" 2>/dev/null || echo "‚ö†Ô∏è No se encontr√≥ carpeta Frameworks"
              echo "Recursos:"
              ls -lh "$APP_PATH"/*.plist 2>/dev/null || echo "‚ö†Ô∏è No se encontraron plists"
            fi
            
            # Verificar recursos y assets (CR√çTICO para que funcione igual que Android)
            echo "üîç Verificando recursos y assets incluidos..."
            if [ -d "$APP_PATH/Assets.car" ] || [ -d "$APP_PATH/Assets.xcassets" ]; then
              echo "‚úÖ Assets encontrados - El dise√±o estar√° disponible"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: Assets no encontrados directamente, pero pueden estar embebidos en el .app"
            fi
            
            # Verificar Info.plist
            if [ -f "$APP_PATH/Info.plist" ]; then
              echo "‚úÖ Info.plist encontrado"
              BUNDLE_ID=$(plutil -extract CFBundleIdentifier raw "$APP_PATH/Info.plist" 2>/dev/null || echo "No encontrado")
              echo "   Bundle ID: $BUNDLE_ID"
            else
              echo "‚ùå ERROR: Info.plist no encontrado - El IPA NO funcionar√°"
              exit 1
            fi
            
            # Verificar frameworks incluidos
            echo "üîç Verificando frameworks incluidos en el .app..."
            if [ -d "$APP_PATH/Frameworks" ]; then
              FRAMEWORK_COUNT=$(find "$APP_PATH/Frameworks" -name "*.framework" -type d | wc -l | tr -d ' ')
              echo "‚úÖ Carpeta Frameworks encontrada con $FRAMEWORK_COUNT frameworks"
              echo "üì¶ Frameworks encontrados:"
              find "$APP_PATH/Frameworks" -name "*.framework" -type d -exec basename {} \; | sort
              
              # Verificar shared framework (Kotlin Multiplatform) - CR√çTICO
              if [ -d "$APP_PATH/Frameworks/shared.framework" ]; then
                SHARED_SIZE=$(du -sh "$APP_PATH/Frameworks/shared.framework" | cut -f1)
                echo "‚úÖ Framework Kotlin Multiplatform encontrado - Tama√±o: $SHARED_SIZE"
                
                # Verificar binario
                if [ -f "$APP_PATH/Frameworks/shared.framework/shared" ]; then
                  BINARY_SIZE=$(du -h "$APP_PATH/Frameworks/shared.framework/shared" | cut -f1)
                  echo "‚úÖ Binario del framework Kotlin encontrado - Tama√±o: $BINARY_SIZE"
                  
                  # Verificar que el binario no est√© vac√≠o
                  if [ ! -s "$APP_PATH/Frameworks/shared.framework/shared" ]; then
                    echo "‚ùå ERROR CR√çTICO: El binario del framework Kotlin est√° vac√≠o"
                    exit 1
                  fi
                  
                  # Verificar headers (necesarios para Swift)
                  if [ -d "$APP_PATH/Frameworks/shared.framework/Headers" ]; then
                    HEADER_COUNT=$(find "$APP_PATH/Frameworks/shared.framework/Headers" -name "*.h" | wc -l | tr -d ' ')
                    echo "‚úÖ Headers del framework encontrados: $HEADER_COUNT archivos"
                  else
                    echo "‚ö†Ô∏è ADVERTENCIA: No se encontraron headers del framework"
                  fi
                  
                  # Verificar Info.plist del framework
                  if [ -f "$APP_PATH/Frameworks/shared.framework/Info.plist" ]; then
                    echo "‚úÖ Info.plist del framework encontrado"
                  else
                    echo "‚ö†Ô∏è ADVERTENCIA: Info.plist del framework no encontrado"
                  fi
              else
                  echo "‚ùå ERROR CR√çTICO: Binario del framework Kotlin NO encontrado"
                  echo "El IPA NO funcionar√° sin el framework Kotlin Multiplatform"
                  exit 1
                fi
              else
                echo "‚ùå ERROR CR√çTICO: Framework Kotlin Multiplatform NO encontrado"
                echo "Buscando en otras ubicaciones..."
                find "$APP_PATH" -name "shared.framework" -type d || echo "No se encontr√≥ shared.framework"
                echo "‚ùå El IPA NO funcionar√° sin el framework Kotlin Multiplatform"
                exit 1
              fi
              
              # Verificar Firebase frameworks
              FIREBASE_FRAMEWORKS=$(find "$APP_PATH/Frameworks" -name "*Firebase*.framework" -type d | wc -l | tr -d ' ')
              echo "üì¶ Frameworks de Firebase encontrados: $FIREBASE_FRAMEWORKS"
              if [ "$FIREBASE_FRAMEWORKS" -lt 4 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: Deber√≠an haber al menos 4 frameworks de Firebase"
              fi
            else
              echo "‚ùå ERROR CR√çTICO: Carpeta Frameworks NO existe en el .app"
              echo "üîß Intentando copiar frameworks manualmente..."
              
              # Crear carpeta Frameworks
              mkdir -p "$APP_PATH/Frameworks"
              
              # Copiar frameworks de CocoaPods (buscar en varias ubicaciones)
              echo "üì¶ Buscando frameworks de CocoaPods..."
              
              # Ubicaci√≥n 1: Pods directo
              if [ -d "iosApp/Pods" ]; then
                echo "  Buscando en iosApp/Pods..."
                find iosApp/Pods -name "*.framework" -type d | while read framework; do
                  framework_name=$(basename "$framework")
                  if [ ! -d "$APP_PATH/Frameworks/$framework_name" ]; then
                    echo "    Copiando $framework_name..."
                    cp -R "$framework" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 2: Build products de CocoaPods
              if [ -d "iosApp/build" ]; then
                echo "  Buscando en iosApp/build..."
                find iosApp/build -name "*.framework" -type d | while read framework; do
                  framework_name=$(basename "$framework")
                  if [ ! -d "$APP_PATH/Frameworks/$framework_name" ]; then
                    echo "    Copiando $framework_name..."
                    cp -R "$framework" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 3: DerivedData (si existe)
              if [ -d "$HOME/Library/Developer/Xcode/DerivedData" ]; then
                echo "  Buscando en DerivedData..."
                find "$HOME/Library/Developer/Xcode/DerivedData" -name "*.framework" -type d 2>/dev/null | while read framework; do
                  framework_name=$(basename "$framework")
                  if [ ! -d "$APP_PATH/Frameworks/$framework_name" ]; then
                    echo "    Copiando $framework_name..."
                    cp -R "$framework" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Copiar shared framework (buscar en varias ubicaciones)
              echo "üì¶ Buscando shared framework..."
              
              # Ubicaci√≥n 1: build/xcode-frameworks
              if [ -d "shared/build/xcode-frameworks" ]; then
                find shared/build/xcode-frameworks -name "shared.framework" -type d | while read shared_fw; do
                  if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
                    echo "  Copiando shared.framework desde xcode-frameworks..."
                    cp -R "$shared_fw" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 2: build/ios (Kotlin Native)
              if [ -d "shared/build/ios" ]; then
                find shared/build/ios -name "shared.framework" -type d | while read shared_fw; do
                  if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
                    echo "  Copiando shared.framework desde build/ios..."
                    cp -R "$shared_fw" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Ubicaci√≥n 3: Pods (si CocoaPods lo copi√≥)
              if [ -d "iosApp/Pods/shared" ]; then
                find iosApp/Pods/shared -name "shared.framework" -type d | while read shared_fw; do
                  if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
                    echo "  Copiando shared.framework desde Pods..."
                    cp -R "$shared_fw" "$APP_PATH/Frameworks/" || true
                  fi
                done
              fi
              
              # Verificar nuevamente
              if [ -d "$APP_PATH/Frameworks" ]; then
                FRAMEWORK_COUNT=$(find "$APP_PATH/Frameworks" -name "*.framework" -type d | wc -l | tr -d ' ')
                echo "‚úÖ Frameworks copiados manualmente: $FRAMEWORK_COUNT frameworks"
                if [ "$FRAMEWORK_COUNT" -gt 0 ]; then
                  echo "üì¶ Frameworks encontrados:"
                  find "$APP_PATH/Frameworks" -name "*.framework" -type d -exec basename {} \; | sort
                  
                  # Verificar tama√±os
                  echo "üìä Tama√±os de frameworks:"
                  du -sh "$APP_PATH/Frameworks"/*.framework 2>/dev/null | sort -h
                else
                  echo "‚ö†Ô∏è ADVERTENCIA: No se encontraron frameworks para copiar"
                  echo "Buscando frameworks en el sistema..."
                  find . -name "*.framework" -type d 2>/dev/null | head -10
                fi
              else
                echo "‚ùå ERROR: No se pudo crear la carpeta Frameworks"
                echo "Contenido del .app:"
                ls -la "$APP_PATH" | head -20
              fi
            fi
            
            # Asegurar que los frameworks est√©n incluidos ANTES de crear el IPA
            echo "üîç Verificaci√≥n final antes de crear IPA..."
            if [ ! -d "$APP_PATH/Frameworks" ] || [ -z "$(ls -A "$APP_PATH/Frameworks" 2>/dev/null)" ]; then
              echo "‚ùå ERROR: No hay frameworks en el .app. El IPA NO funcionar√°."
              echo "Intentando copiar frameworks una vez m√°s..."
              mkdir -p "$APP_PATH/Frameworks"
              
              # Buscar y copiar todos los frameworks disponibles
              find . -name "*.framework" -type d 2>/dev/null | grep -E "(Firebase|shared|Pods)" | while read fw; do
                fw_name=$(basename "$fw")
                if [ ! -d "$APP_PATH/Frameworks/$fw_name" ]; then
                  echo "  Copiando $fw_name desde $(dirname $fw)..."
                  cp -R "$fw" "$APP_PATH/Frameworks/" 2>/dev/null || true
                fi
              done
              
              FRAMEWORK_COUNT=$(find "$APP_PATH/Frameworks" -name "*.framework" -type d 2>/dev/null | wc -l | tr -d ' ')
              echo "üìä Total de frameworks incluidos: $FRAMEWORK_COUNT"
              
              # Verificar frameworks cr√≠ticos
              CRITICAL_FRAMEWORKS=("shared.framework")
              MISSING_FRAMEWORKS=()
              
              for FW in "${CRITICAL_FRAMEWORKS[@]}"; do
                if [ ! -d "$APP_PATH/Frameworks/$FW" ]; then
                  MISSING_FRAMEWORKS+=("$FW")
                fi
              done
              
              if [ ${#MISSING_FRAMEWORKS[@]} -gt 0 ]; then
                echo "‚ùå ERROR CR√çTICO: Frameworks faltantes: ${MISSING_FRAMEWORKS[*]}"
                echo "El IPA NO funcionar√° correctamente sin estos frameworks."
                exit 1
              fi
              
              if [ "$FRAMEWORK_COUNT" -lt 5 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: Solo se encontraron $FRAMEWORK_COUNT frameworks. Se esperan al menos 5."
                echo "Verificando frameworks cr√≠ticos..."
                if [ ${#MISSING_FRAMEWORKS[@]} -eq 0 ]; then
                  echo "‚úÖ Frameworks cr√≠ticos presentes, continuando..."
                else
                  echo "‚ùå ERROR: Frameworks cr√≠ticos faltantes"
                exit 1
                fi
              fi
            fi
            
            # Verificaci√≥n final completa
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üîç VERIFICACI√ìN FINAL DEL .APP"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # Verificar tama√±o final del .app
            FINAL_APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "üìä Tama√±o final del .app: ${FINAL_APP_SIZE}MB"
            if [ "$FINAL_APP_SIZE" -lt 10 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: El .app es peque√±o (${FINAL_APP_SIZE}MB). Deber√≠a ser ~20-50MB con todos los frameworks."
            fi
            
            # Verificar que el framework Kotlin est√© presente y funcional (CR√çTICO - sin esto la app crashear√°)
            if [ -d "$APP_PATH/Frameworks/shared.framework" ] && [ -f "$APP_PATH/Frameworks/shared.framework/shared" ]; then
              echo "‚úÖ Framework Kotlin Multiplatform: PRESENTE Y FUNCIONAL"
              SHARED_FINAL_SIZE=$(du -sh "$APP_PATH/Frameworks/shared.framework" | cut -f1)
              echo "   Tama√±o: $SHARED_FINAL_SIZE"
              
              # Verificar que el binario tenga contenido (no est√© vac√≠o)
              if [ ! -s "$APP_PATH/Frameworks/shared.framework/shared" ]; then
                echo "‚ùå ERROR CR√çTICO: El binario del framework Kotlin est√° vac√≠o - La app CRASHEAR√Å"
                exit 1
              fi
              
              # Verificar headers (necesarios para Swift)
              if [ -d "$APP_PATH/Frameworks/shared.framework/Headers" ]; then
                HEADER_COUNT=$(find "$APP_PATH/Frameworks/shared.framework/Headers" -name "*.h" | wc -l | tr -d ' ')
                echo "‚úÖ Headers del framework encontrados: $HEADER_COUNT archivos"
              else
                echo "‚ö†Ô∏è ADVERTENCIA: Headers del framework no encontrados - Puede causar problemas"
              fi
              
              echo "‚úÖ Framework Kotlin verificado - La app funcionar√° correctamente"
            else
              echo "‚ùå ERROR CR√çTICO: Framework Kotlin Multiplatform NO est√° presente"
              echo "   Sin este framework, la app CRASHEAR√Å al iniciar"
              echo "   El c√≥digo compartido entre Android e iOS no estar√° disponible"
              exit 1
            fi
            
            # Listar todos los frameworks incluidos
            echo "üì¶ Frameworks incluidos en el IPA:"
            find "$APP_PATH/Frameworks" -name "*.framework" -type d -exec basename {} \; | sort | while read fw; do
              fw_size=$(du -sh "$APP_PATH/Frameworks/$fw" 2>/dev/null | cut -f1)
              echo "   - $fw ($fw_size)"
            done
            
            # Verificaci√≥n final cr√≠tica antes de crear IPA
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üîç VERIFICACI√ìN FINAL CR√çTICA PARA INSTALACI√ìN EN IPHONE"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # 1. Framework Kotlin presente
            if [ ! -d "$APP_PATH/Frameworks/shared.framework" ]; then
              echo "‚ùå ERROR: Framework Kotlin faltante - La app NO funcionar√°"
              exit 1
            fi
            
            # 2. Info.plist presente
            if [ ! -f "$APP_PATH/Info.plist" ]; then
              echo "‚ùå ERROR: Info.plist faltante - El IPA NO se instalar√°"
              exit 1
            fi
            
            # 3. Tama√±o m√≠nimo del .app
            FINAL_APP_SIZE_MB=$(du -sm "$APP_PATH" | cut -f1)
            if [ "$FINAL_APP_SIZE_MB" -lt 5 ]; then
              echo "‚ö†Ô∏è ADVERTENCIA: El .app es muy peque√±o (${FINAL_APP_SIZE_MB}MB)"
              echo "   Puede faltar contenido, pero continuando..."
            fi
            
            # 4. Verificar que el ejecutable principal existe y es v√°lido
            EXECUTABLE_NAME=$(plutil -extract CFBundleExecutable raw "$APP_PATH/Info.plist" 2>/dev/null || echo "NequixiOS")
            if [ ! -f "$APP_PATH/$EXECUTABLE_NAME" ]; then
              echo "‚ùå ERROR: Ejecutable principal no encontrado - El IPA NO funcionar√°"
              exit 1
            fi
            
            # Verificar que el ejecutable tenga permisos de ejecuci√≥n
            if [ ! -x "$APP_PATH/$EXECUTABLE_NAME" ]; then
              echo "‚ö†Ô∏è Ejecutable sin permisos, agregando..."
              chmod +x "$APP_PATH/$EXECUTABLE_NAME"
            fi
            
            # Verificar que el ejecutable no est√© vac√≠o
            EXECUTABLE_SIZE=$(stat -f%z "$APP_PATH/$EXECUTABLE_NAME" 2>/dev/null || stat -c%s "$APP_PATH/$EXECUTABLE_NAME" 2>/dev/null || echo "0")
            if [ "$EXECUTABLE_SIZE" -lt 1000 ]; then
              echo "‚ùå ERROR: El ejecutable est√° vac√≠o o corrupto (${EXECUTABLE_SIZE} bytes) - El IPA NO funcionar√°"
              exit 1
            fi
            echo "‚úÖ Ejecutable principal encontrado y v√°lido: $EXECUTABLE_NAME (${EXECUTABLE_SIZE} bytes)"
            
            # 5. Verificar que los frameworks est√©n correctamente vinculados
            echo "üîç Verificando vinculaci√≥n de frameworks..."
            if otool -L "$APP_PATH/$EXECUTABLE_NAME" 2>/dev/null | grep -q "shared.framework"; then
              echo "‚úÖ Framework Kotlin correctamente vinculado al ejecutable"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: Framework Kotlin no encontrado en la vinculaci√≥n del ejecutable"
              echo "   Verificando si est√° en Frameworks..."
              if [ -d "$APP_PATH/Frameworks/shared.framework" ]; then
                echo "   ‚úÖ Framework presente en Frameworks, puede estar vinculado din√°micamente"
              else
                echo "   ‚ùå ERROR: Framework no encontrado - La app CRASHEAR√Å"
                exit 1
              fi
            fi
            
            # 6. Verificar estructura del IPA (evitar problemas de instalaci√≥n)
            echo "üîç Verificando estructura del .app para instalaci√≥n..."
            
            # Verificar que no falten archivos cr√≠ticos de iOS
            CRITICAL_FILES=(
              "$APP_PATH/Info.plist"
              "$APP_PATH/$EXECUTABLE_NAME"
            )
            
            for FILE in "${CRITICAL_FILES[@]}"; do
              if [ ! -f "$FILE" ]; then
                echo "‚ùå ERROR CR√çTICO: Archivo faltante: $FILE"
                echo "   El IPA NO se instalar√° correctamente"
                exit 1
              fi
            done
            echo "‚úÖ Todos los archivos cr√≠ticos presentes"
            
            # Verificar permisos del .app
            if [ ! -r "$APP_PATH" ] || [ ! -x "$APP_PATH" ]; then
              echo "‚ö†Ô∏è Corrigiendo permisos del .app..."
              chmod -R u+rX "$APP_PATH"
            fi
            
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ VERIFICACI√ìN COMPLETA - El IPA est√° listo para instalar en iPhone"
            echo "   - Framework Kotlin Multiplatform: ‚úÖ (evita crashes)"
            echo "   - Recursos y dise√±o: ‚úÖ (muestra correctamente)"
            echo "   - Info.plist: ‚úÖ (permite instalaci√≥n)"
            echo "   - Ejecutable: ‚úÖ (app inicia correctamente)"
            echo "   - Frameworks vinculados: ‚úÖ (no crashea)"
            echo "   - Estructura v√°lida: ‚úÖ (se instala correctamente)"
            echo "   - Tama√±o: ${FINAL_APP_SIZE_MB}MB"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ El IPA NO se cerrar√° ni crashear√° al instalarse"
            echo "‚úÖ Funcionar√° igual que en Android (Kotlin Multiplatform)"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # Exportar IPA firmado usando Codemagic (m√©todo correcto)
            echo "üì¶ Exportando IPA firmado con Codemagic..."
            EXPORT_OPTIONS_PLIST="iosApp/ExportOptions.plist"
            
            # Verificar que ExportOptions.plist existe
            if [ ! -f "$EXPORT_OPTIONS_PLIST" ]; then
              echo "‚ö†Ô∏è ExportOptions.plist no encontrado, usando exportaci√≥n autom√°tica de Codemagic"
              EXPORT_OPTIONS_PLIST=""
            fi
            
            # Exportar usando xcodebuild (Codemagic maneja la firma autom√°ticamente)
            if [ -n "$EXPORT_OPTIONS_PLIST" ] && [ -f "$EXPORT_OPTIONS_PLIST" ]; then
              echo "üìù Usando ExportOptions.plist para exportar IPA..."
              xcodebuild -exportArchive \
                -archivePath build/archive.xcarchive \
                -exportPath build/ios/ipa \
                -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" 2>&1 | tee export.log || {
                echo "‚ö†Ô∏è Error en exportArchive, usando m√©todo alternativo..."
                # Fallback: crear IPA manualmente (ya est√° firmado por Codemagic durante archive)
                mkdir -p build/ios/ipa/Payload
                cp -R "$APP_PATH" build/ios/ipa/Payload/
                cd build/ios/ipa
                zip -r ../NequixiOS.ipa Payload
                cd ../../..
              }
            else
              echo "üìù Creando IPA manualmente desde archive firmado..."
              mkdir -p build/ios/ipa/Payload
              cp -R "$APP_PATH" build/ios/ipa/Payload/
              cd build/ios/ipa
              zip -r ../NequixiOS.ipa Payload
              cd ../../..
            fi
            
            # Buscar el IPA exportado
            IPA_EXPORTED=$(find build/ios/ipa -name "*.ipa" -type f | head -1)
            if [ -n "$IPA_EXPORTED" ]; then
              echo "‚úÖ IPA exportado correctamente: $IPA_EXPORTED"
              mv "$IPA_EXPORTED" build/ios/ipa/NequixiOS.ipa 2>/dev/null || true
            fi
            
            echo "‚úÖ IPA creado y firmado - Listo para AppTzio"
            
            # Buscar el IPA generado
            IPA_PATH=$(find build/ios/ipa -name "*.ipa" -type f | head -1)
            if [ -z "$IPA_PATH" ]; then
              IPA_PATH="build/ios/ipa/NequixiOS.ipa"
            fi
            echo "‚úÖ IPA creado: $IPA_PATH"
            # Verificar que el IPA existe
            if [ -f "$IPA_PATH" ]; then
              IPA_SIZE=$(du -h "$IPA_PATH" | cut -f1)
              IPA_SIZE_MB=$(du -sm "$IPA_PATH" | cut -f1)
              ls -lh "$IPA_PATH"
              echo "‚úÖ IPA verificado correctamente - Tama√±o: ${IPA_SIZE} (${IPA_SIZE_MB}MB)"
              
              if [ "$IPA_SIZE_MB" -lt 5 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: El IPA es muy peque√±o (${IPA_SIZE_MB}MB). Puede faltar contenido."
                echo "Verificando contenido del IPA..."
                unzip -l "$IPA_PATH" | head -30
              elif [ "$IPA_SIZE_MB" -lt 20 ]; then
                echo "‚ö†Ô∏è ADVERTENCIA: El IPA es peque√±o (${IPA_SIZE_MB}MB). Deber√≠a ser ~30-50MB con todos los frameworks."
                echo "Verificando frameworks incluidos..."
                unzip -l "$IPA_PATH" | grep -E "(Frameworks|\.framework)" | head -20
              else
                echo "‚úÖ Tama√±o del IPA parece correcto (${IPA_SIZE_MB}MB)"
              fi
            else
              echo "‚ö†Ô∏è IPA no encontrado en $IPA_PATH, buscando..."
              FOUND_IPA=$(find build -name "*.ipa" -type f | head -1)
              if [ -n "$FOUND_IPA" ]; then
                echo "‚úÖ IPA encontrado en: $FOUND_IPA"
                ls -lh "$FOUND_IPA"
                # Copiar al lugar esperado
                mkdir -p build/ios/ipa
                cp "$FOUND_IPA" "$IPA_PATH"
                echo "‚úÖ IPA copiado a ubicaci√≥n esperada"
              else
                echo "‚ùå No se encontr√≥ ning√∫n IPA"
                exit 1
              fi
            fi
          else
            echo "‚ùå No se encontr√≥ la aplicaci√≥n en el archive"
            echo "Contenido de archive:"
            ls -la build/archive.xcarchive/ || true
            ls -la build/archive.xcarchive/Products/ || true
            exit 1
          fi
            
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/ipa/NequixiOS.ipa
      
    publishing:
      email:
        recipients:
          - tu-email@gmail.com
        notify:
          success: true
          failure: true

